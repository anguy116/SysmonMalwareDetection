import shutil
import os
import sqlite3
import glob
import zipfile
import sys,getopt
types = ["trojan"]

def foo(c):
    for tpe in types:
        print(tpe)
        os.mkdir(tpe)
        if tpe != "rest":
            c = conn.cursor()
            c.execute("SELECT TYPE,NAME,LOCATION FROM MALWARES WHERE TYPE='"+tpe+"';")
            for row in c.fetchall():
                loc = row[2]
                tpe = row[0]
                nm =  row[1]
                if 'Binaries/' in loc:
                    for file in glob.glob("MalwareZoo-master/"+loc+"/*.zip"):
                        shutil.copy(file,tpe+"/")

    c = conn.cursor()
    c.execute("SELECT TYPE,NAME,LOCATION FROM MALWARES WHERE TYPE NOT IN ('botnet','apt','trojan');")
    os.mkdir('rest')
    for row in c.fetchall():
        loc = row[2]
        for file in glob.glob("MalwareZoo-master/"+loc+"/*.zip"):
            shutil.copy(file,"rest/")
            
def unzip():
    os.chdir("C:/Users/resea/Desktop/trojan")
    for file in os.listdir():
        print(file[:-4])
        try:
            with zipfile.ZipFile(file,'r') as zip_ref:
                        zip_ref.extractall(file[:-4], pwd= bytes('infected','utf-8'))
        
        except Exception:
            print("couldn't unzip "+file)
            pass
    

if __name__=="__main__":
    args = sys.argv[1:]
    try:
        opts, args = getopt.getopt(args,"h:m:",["mode="])
    except getopt.GetOptError:
        print ('move.py -m <mode>')
        sys.exit(2)
    for opt, arg in opts:
        if opt == "-h":
            print("-m | --mode")
            print("separate --- seperates malware by category")
            print("unzip --- unzips malware in category")

        elif opt in ("-m","--mode"):
            if arg == "separate":
                conn = sqlite3.connect('MalwareZoo-master/conf/maldb.db')
                foo(conn)
            elif arg == "unzip":
                unzip()

